name: Trivy Security Scan (Reusable)

on:
  workflow_call:
    inputs:
      scan_target:
        description: "Path or directory to scan (default: .)"
        required: false
        type: string
        default: "."

jobs:
  trivy_scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_findings: ${{ steps.check.outputs.has_findings }}

    steps:
      - name: Checkout Source
        uses: actions/checkout@v5

      - name: Run Trivy Filesystem Scan
        id: trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scan-ref: ${{ inputs.scan_target }}
          ignore-unfixed: true
          format: table
          output: trivy-report.txt
          vuln-type: os,library
          exit-code: 0           # soft mode â€“ will not fail the job
          severity: HIGH,CRITICAL

      - name: Check for HIGH/CRITICAL Vulnerabilities
        id: check
        run: |
          if grep -q "CRITICAL" trivy-report.txt || grep -q "HIGH" trivy-report.txt; then
            echo "has_findings=true" >> $GITHUB_OUTPUT
          else
            echo "has_findings=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Trivy Report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: trivy-scan-report
          path: trivy-report.txt
