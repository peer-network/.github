name: Auto-Label PR

on:
  workflow_call:
    inputs:
      label_config:
        description: "JSON map of patterns to labels"
        type: string
        required: true
      mode:
        description: "soft or hard"
        type: string
        default: "soft"
    secrets:
      GH_TOKEN:
        required: true

jobs:
  autolabel:
    name: Apply Auto-Labels
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          separator: ","

      - name: Parse config
        id: cfg
        run: |
          cat <<'EOF' > config.json
          ${{ inputs.label_config }}
          EOF

          jq empty config.json || {
            echo "::error ::Invalid label_config JSON"
            exit 1
          }

          config=$(jq -c . config.json)
          echo "config=$config" >> "$GITHUB_OUTPUT"

      - name: Match patterns
        id: match
        run: |
          files="${{ steps.changed.outputs.all_modified_files }}"
          echo "Changed files: $files"

          labels=()

          # loop through config
          for pattern in $(jq -r 'keys[]' config.json); do
            label=$(jq -r --arg p "$pattern" '.[$p]' config.json)

            if echo "$files" | tr "," "\n" | grep -E "$pattern" >/dev/null 2>&1; then
              echo "Matched $pattern → $label"
              labels+=("$label")
            fi
          done

          if [ "${#labels[@]}" -eq 0 ]; then
            labels_json="[]"
          else
            labels_json=$(printf '%s\n' "${labels[@]}" \
              | sed '/^$/d' \
              | sort -u \
              | jq -R . \
              | jq -s -c .)
            fi

            echo "labels=$labels_json" >> "$GITHUB_OUTPUT"

      - name: Apply labels
        if: steps.match.outputs.labels != '[]'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const labels = ${{ steps.match.outputs.labels }}.filter(Boolean);

            if (labels.length === 0) {
              console.log("No labels to apply — skipping");
              return;
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels,
            });

      - name: Hard mode check
        if: inputs.mode == 'hard'
        run: |
          if [[ "${{ steps.match.outputs.labels }}" == "[]" ]]; then
            echo "::error ::Hard mode enabled but no labels matched."
            exit 1
          fi
